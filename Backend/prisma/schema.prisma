// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
 // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  ADMIN
  DENTIST
}

model User {
  id        String   @id @default(uuid())
  emailAddress     String   @unique
  firstName String
  lastName String
  userName  String   @unique
  phoneNumber String @unique
  address String
  city String
  state String  
  password  String
  dateOfBirth DateTime
  role      UserRole @default(PATIENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Role-specific relationships
  patient   Patient?
  dentist   Dentist?
  admin     Admin?
  payments  Payment[]
  
  @@map("users")
}

model Patient {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Patient-specific fields
  emergencyContact String @default("None")
  insuranceProvider String @default("N/A")
  insuranceNumber   String @default("None")
  medicalHistory    String @default("None")
  allergies         String @default("None")
  
  // Appointments relationship
  appointments Appointment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("patients")
}

model Dentist {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dentist-specific fields
  dentistId       String   @unique // Professional license number
  specialization  String
  education      String
  experience     Int      // Years of experience
  bio            String?
  availability   String?
  hourlyRate     Decimal  @db.Decimal(10,2)
  
  // Appointments relationship
  appointments Appointment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("dentists")
}

model Admin {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Admin-specific fields
  adminLevel      String   @default("STAFF") // STAFF, MANAGER, SUPER_ADMIN
  permissions     String[] // Array of permission strings
  department      String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("admins")
}

model Appointment {
  id          String   @id @default(uuid())
  patientId   String
  dentistId   String
  patient     Patient  @relation(fields: [patientId], references: [id])
  dentist     Dentist  @relation(fields: [dentistId], references: [id])
  
  // Appointment details
  appointmentDate DateTime
  timeSlot        String   
  duration        Int     
  appointmentType String   
  conditionDescription String
  patientAge          Int
  conditionDuration   String  
  severity            String   
  status          String   @default("SCHEDULED")
  notes           String?   
  videoChatLink   String?
  meetingPassword String?  
  prescriptions Prescription[]  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt  
  @@map("appointments")
}

model Prescription {
  id          String   @id @default(uuid())
  prescriptionNumber String @unique 
  appointmentId String
  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)  
  issueDate   DateTime @default(now())
  expiryDate  DateTime
  status      String   @default("ACTIVE")   
  // Medical details
  diagnosis   String?
  notes      String?  
  // Relationships
  medications Medication[]
  deliveries PrescriptionDelivery[]  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt  
  @@map("prescriptions")
}

model Medication {
  id              String   @id @default(uuid())
  prescriptionId  String
  prescription    Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  // Medication details
  medicationName   String
  dosage          String  // e.g., "500 mg"
  frequency       String  // e.g., "3 times daily"
  duration        String  // e.g., "7 days"
  instructions    String? // e.g., "Take with food"
  quantity        Int
  refills         Int     @default(0)
  
  // Medical coding
  medicationCode  String? // RxNorm code
  dosageForm     String? // e.g., "capsule", "tablet"
  strength       String? // e.g., "500mg"
  
  // Order of use
  orderOfUse     Int     @default(1) // 1, 2, 3... for multiple medications
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("medications")
}

model PrescriptionDelivery {
  id              String   @id @default(uuid())
  prescriptionId  String
  prescription    Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  
  // Delivery details
  deliveryMethod String  @default("EMAIL") // EMAIL, SMS, etc.
  recipientEmail String?
  status         String  @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  
  // Tracking
  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  failureReason  String?
  
  // Retry mechanism
  attemptCount   Int     @default(0)
  maxAttempts    Int     @default(3)
  lastAttemptAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("prescription_deliveries")
}

model Payment {
  id                 String   @id @default(uuid())
  merchantRequestId  String
  checkoutRequestId  String   @unique
  resultCode         Int
  resultDesc         String

  amount             Decimal  @db.Decimal(10,2)
  mpesaReceiptNumber String?
  transactionDate    DateTime?
  phoneNumber        String?
  accountReference   String?

  rawCallback        Json

  
  userId             String?
  user               User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  status             String   @default("PENDING")

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("payments")
}